<!DOCTYPE html>
<html>
<head>
	<title>d3.js with leaflet.js</title>

    
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
    <!--Customized CSS-->
    <style>
    .hull {
        fill: steelblue;
        stroke: steelblue;
        stroke-width: 16px;
        stroke-linejoin: round;
        opacity: 0.5
    }
    .group.a { fill: #FF5252; stroke: #FF5252;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.b { fill: #673AB7; stroke: #673AB7;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.c { fill: #42A5F5; stroke: #42A5F5;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.d { fill: #009688; stroke: #009688;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.e { fill: #C0CA33; stroke: #C0CA33;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}

    .place-label {
        fill: black;
        fill-opacity: .8;
        font-size: 20px;
        font-weight: 300;
        text-anchor: middle;
    }
    </style>
</head>
<body>
    <div id="Panel">
        <h1>Territory Allocation Demo</h1>
    </div>
	<div id="map" style="width: 1024px; height: 600px"></div>
	<script type="text/javascript">
        var map = L.map('map').setView([42.877742, -97.380979], 4);
        mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 18,
            }).addTo(map);
        L.svg({clickable:true}).addTo(map);	

        // Sales reps locations
        var reps = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 1",
        "group": "a",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [26.34275055, -81.31328583]
      }
    },

    {
      "type": "Feature",
      "properties": {
        "name": "Rep 2",
        "group": "a",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [39.530895, -119.814972]
      }
    },

    {
      "type": "Feature",
      "properties": {
        "name": "Rep 3",
        "group": "a",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [42.51844406, -87.9826355]
      }
    },
 
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 4",
        "group": "a",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [39.95080566, -105.1594925]
      }
    },
  
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 5",
        "group": "a",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [28.2949, -80.666]
      }
    },
    
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 6",
        "group": "b",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [35.76341248, -78.78852844]
      }
    },
    
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 7",
        "group": "b",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [40.86263275, -73.31693268]
      }
    },
    
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 8",
        "group": "b",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [29.89461136, -92.19317627]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 9",
        "group": "b",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [32.57073975, -97.14483643]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Rep 10",
        "group": "b",
      },
      "geometry": {
        "type": "Point",
        "coordinates": [42.29540634, -87.9506073]
      }
    },

  ]
};	

	/* We simply pick up the SVG from the map object */
	var svg = d3.select("#map").select("svg")
    .attr("pointer-events", "auto");
	g = svg.append("g");

    /* Add a LatLng object to each item in the dataset */
    var p=[]
    reps.features.forEach(function(d) {
        d.LatLng = new L.LatLng(d.geometry.coordinates[0],
                                d.geometry.coordinates[1]);
        p.push([d.geometry.coordinates[0],d.geometry.coordinates[1]]);
    })


    var states = [  
      {
        "type": "Feature",
        "properties": {"id":"a"},
        "geometry": {
            "type": "Polygon",
            "coordinates": [],
            "points":[]
        }
    },

    {
        "type": "Feature",
        "properties": {"id":"b"},
        "geometry": {
            "type": "Polygon",
            "coordinates": [],
            "points":[]
        }
    }
];
    function getHull(){
        // Clean all points in states
        states.forEach(function(e){e.geometry.points=[];});
        // Assign poitns
        reps.features.forEach(function(d) {
            var target = states.find(function(g){
                return g.properties.id===d.properties.group
            })
            target.geometry.points.push([d.geometry.coordinates[0],d.geometry.coordinates[1]]);
        })
        //Calculate hull
        states.forEach(function(e){
            var hull =  d3.polygonHull(e.geometry.points);
            hull.push([]);
            e.geometry.coordinates = [hull];});
    }
    

    function projectPoint(x, y) {
        var point = map.latLngToLayerPoint(new L.LatLng(x, y));
        this.stream.point(point.x, point.y);
    }

    var transform = d3.geoTransform({point: projectPoint});
    var path = d3.geoPath().projection(transform);
    var story = [
            {"point":0, "from":"a", "to":"b"},
            {"point":9, "from":"b", "to":"a"},
            {"point":8, "from":"b", "to":"a"},
            {"point":0, "from":"b", "to":"a"},
            {"point":9, "from":"a", "to":"b"},
            {"point":8, "from":"a", "to":"b"},
            ]
    var index = 0;
    var blink = story[index].point;
    // Draw the convex hull
    var featureHull =  svg.selectAll("path")
        .data(states)
        .enter()
        .append("path")
        .attr("class", function(d){return "group "+d.properties.id})
        

    var feature = g.selectAll("circle")
        .data(reps.features)
        .enter()
        .append("circle")
        .attr("class", "dot")
        .style("opacity", .9) 
        .style("fill", "red")
        .style("stroke","black")
        .attr("r", 6)

    var featureLabel = svg.selectAll(".place-label")
            .data(reps.features)
           
    var blinkRing = svg.selectAll("ring")
        .data(reps.features);


    getHull();
    var blinkingID = setInterval(transition, 300);
    var storyTransitionID = setInterval(script, 3000);
    map.on("moveend", update);
    map.on('zoomend', update);
    update();

    function update() {
        featureHull.attr("d", path)

        feature.attr("transform", function(d) { 
            return "translate("+ 
                map.latLngToLayerPoint(d.LatLng).x +","+ 
                map.latLngToLayerPoint(d.LatLng).y +")";
        });

        featureLabel.filter(function(d,i){return i===blink;})
        .attr("transform", function(d) { 
            return "translate(" + 
                (map.latLngToLayerPoint(d.LatLng).x+10) +","+ 
                (map.latLngToLayerPoint(d.LatLng).y-10) +")";
        })
            //.attr("dy", ".35em")
            .text(function(d) { return d.properties.name; }); 
    }



    function script(){
        // Blinking point id
        blink = story[index].point;
        // Change the group
        reps.features[blink].properties.group = story[index].to;
        // Update the convex hull
        getHull()

        featureLabel.enter()
            .append("text")
            .attr("class", "place-label")
            .filter(function(d,i){return i===blink;})
            .attr("transform", function(d) { 
            return "translate(" + 
                (map.latLngToLayerPoint(d.LatLng).x) +","+ 
                (map.latLngToLayerPoint(d.LatLng).y-20) +")";
            })
            .attr("dy", ".35em")
            .text(function(d) {return d.properties.name; })
            .transition()
            .duration(3000)
            .remove();

        // draw hull
        featureHull.data(states)
        .transition()
            .delay(3000)
            .duration(1000)
            .attr("d", path)
        // update the story
        console.log(index)
        index = index==(story.length-1)?0:(index+1);
        
        update();
    }
    function transition(){
        blinkRing.enter()
        .append("circle")
        // Using filter to select a specific element
        .filter(function(d,i){return i===blink;})
            .attr("class", "ring")
            .attr("transform", function(d) { 
                return "translate("+ 
                    map.latLngToLayerPoint(d.LatLng).x +","+ 
                    map.latLngToLayerPoint(d.LatLng).y +")";})
            .attr("r", 6)
            .style("stroke-width", 1)
            .style("stroke", "red")
            .style("fill", "none")
        .transition()
            .ease(d3.easeLinear)
            .duration(1000) // Change Speed
            .style("stroke-opacity", 1e-6)
            .style("stroke-width", 3)
            .style("stroke", "red")
            .attr("r", 35)
            .remove();
    }


</script>
</body>
</html>