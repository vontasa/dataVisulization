<!DOCTYPE html>
<html>
<head>
	<title>d3.js with leaflet.js</title>

    
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>





    <!--Customized CSS-->
    <style>
    .hull {
        fill: steelblue;
        stroke: steelblue;
        stroke-width: 16px;
        stroke-linejoin: round;
        opacity: 0.5
    }
    .group.RD-1 { fill: #FF5252; stroke: #FF5252;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-2 { fill: #673AB7; stroke: #673AB7;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-3 { fill: #42A5F5; stroke: #42A5F5;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-4 { fill: #009688; stroke: #009688;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-5 { fill: #C0CA33; stroke: #C0CA33;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}

    .group.RD-6 { fill: #800000; stroke: #800000;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-7 { fill: #990099; stroke: #990099;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-8 { fill: #ff9900; stroke: #ff9900;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}
    .group.RD-9 { fill: #109618; stroke: #109618;stroke-width: 16px;stroke-linejoin: round;opacity: 0.5}

    .tooltip {	
        position: absolute;			
        text-align: center;			
        width: 150px;					
        height: 60px;					
        padding: 2px;				
        font: 16px sans-serif;		
        background: lightsteelblue;	
        border: 0.5px;		
        border-radius: 8px;			
        pointer-events: none;		
        z-index: 314159;
    }

    #map{
      width: 1024px; 
      height: 600px;
      position: relative;
    }

    .place-label {
        fill: black;
        fill-opacity: .8;
        font-size: 20px;
        font-weight: 300;
        text-anchor: middle;
    }

    .container {
      width: 100px;
      margin: 0 auto;
    }

    .button {
        padding: 0;
        width: 100px;
        height: 100px;
        border: 0;
        background-color: white;
        outline: none;
    }
    </style>
</head>
<body>
    <div id="Panel">
        <h1>Territory Allocation Demo</h1>

        <button id="play" class="button js-button">
            <svg viewBox="0 0 36 36" >
                <defs>
                    <path id="pause-icon" data-state="playing" d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26" />
                    <path id="play-icon"  data-state="paused"  d="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28" />
                </defs>
                <use xlink:href="#play-icon" />
            </svg>
        </button>
        </br>
        <div class="btn-group mr-2" role="group" aria-label="First group" >
            <button type="button" class="btn btn-secondary" onclick="reset()">Reset</button>
            <button type="button" class="btn btn-secondary" onclick="goToStage(5)">End</button>
        </div>

    </div>
	<div id="map"></div>
	<script type="text/javascript">
    var playButton = {
        el: document.querySelector(".js-button"),
        states: {
            playing: {
                nextState: "paused",
                iconEl: document.querySelector("#pause-icon")
            },
            paused:  {
                nextState: "playing",
                iconEl: document.querySelector("#play-icon")
            }
        },

        animationDuration: 350,

        init: function () {
            this.setInitialState();
            this.replaceUseEl();
            this.el.addEventListener("click", this.goToNextState.bind(this));
        },

        setInitialState: function () {
          var initialIconRef = this.el.querySelector("use").getAttribute("xlink:href");
          var stateName = this.el.querySelector(initialIconRef).getAttribute("data-state");
          this.setState(stateName);
        },

        replaceUseEl: function () {
            d3.select(this.el.querySelector("use")).remove();
            d3.select(this.el.querySelector("svg")).append("path")
                .attr("class", "js-icon")
                .attr("d", this.stateIconPath());
        },

        goToNextState: function () {
            this.setState(this.state.nextState);

            d3.select(this.el.querySelector(".js-icon")).transition()
                .duration(this.animationDuration)
                .attr("d", this.stateIconPath());
        },

        setState: function (stateName) {
            this.state = this.states[stateName];
        },

        stateIconPath: function () {
            return this.state.iconEl.getAttribute("d");
        }
    };

    playButton.init();
    var map = L.map('map').setView([42.877742, -97.380979], 4);
    mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
    L.tileLayer(
        'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; ' + mapLink + ' Contributors',
        maxZoom: 18,
        }).addTo(map);
    L.svg({clickable:true}).addTo(map);	

    // Sales reps locations
var reps = {
                  "type": "FeatureCollection",
                  "features": [
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-36",
                              "group": "RD-9",
                              "territoryscore": 19.8451250971849
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [36.12694168, -95.94669342]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-40",
                              "group": "RD-9",
                              "territoryscore": 12.8984606671882
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [33.50667191, -86.74446106]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-58",
                              "group": "RD-9",
                              "territoryscore": 88.1581291736616
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [35.61878967, -97.484375]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-23",
                              "group": "RD-9",
                              "territoryscore": 1.75298960867627
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [34.44923782, -93.0942688]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-1",
                              "group": "RD-1",
                              "territoryscore": 83.7507672590032
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [28.2949, -80.666]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-2",
                              "group": "RD-1",
                              "territoryscore": 62.4290342478601
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [26.34275055, -81.31328583]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-46",
                              "group": "RD-1",
                              "territoryscore": 3.59937503211307
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [30.29880524, -81.72123718]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-43",
                              "group": "RD-1",
                              "territoryscore": 0.659012125086489
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [35.13050842, -80.85668182]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-57",
                              "group": "RD-1",
                              "territoryscore": 14.8235102584518
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [25.88333702, -80.13182831]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-37",
                              "group": "RD-1",
                              "territoryscore": 31.6307373366736
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [33.93427658, -84.46218872]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-35",
                              "group": "RD-1",
                              "territoryscore": 0.69293502329944
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [28.03306007, -82.72437286]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-39",
                              "group": "RD-1",
                              "territoryscore": 71.6630687200776
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [31.85149574, -81.26218414]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-56",
                              "group": "RD-1",
                              "territoryscore": 23.0178851837346
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [36.1338768, -86.80125427]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-16",
                              "group": "RD-4",
                              "territoryscore": 44.2538172032825
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.36856079, -76.61489868]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-12",
                              "group": "RD-4",
                              "territoryscore": 47.7187275615761
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.97993469, -70.82943726]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-13",
                              "group": "RD-4",
                              "territoryscore": 47.3393356412411
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.24687195, -71.17945862]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-45",
                              "group": "RD-4",
                              "territoryscore": 62.4623168616865
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [40.65742874, -75.5042572]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-7",
                              "group": "RD-4",
                              "territoryscore": 16.7828485833379
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [40.86263275, -73.31693268]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-33",
                              "group": "RD-4",
                              "territoryscore": 14.0707367185594
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [40.9990921, -74.16884613]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-47",
                              "group": "RD-4",
                              "territoryscore": 17.0149015040601
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [40.32630539, -75.36842346]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-51",
                              "group": "RD-4",
                              "territoryscore": 63.0366460734776
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [40.18046951, -74.83726501]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-9",
                              "group": "RD-5",
                              "territoryscore": 3.1732313907369
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [32.57073975, -97.14483643]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-28",
                              "group": "RD-5",
                              "territoryscore": 9.59809107068553
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [29.77154541, -95.41107941]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-55",
                              "group": "RD-5",
                              "territoryscore": 7.95569875675221
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [30.04044724, -95.52902222]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-52",
                              "group": "RD-5",
                              "territoryscore": 35.6991800295627
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [32.62189484, -97.09350586]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-32",
                              "group": "RD-5",
                              "territoryscore": 50.1686448443791
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [32.57073975, -97.14483643]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-24",
                              "group": "RD-5",
                              "territoryscore": 52.3329070030144
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [30.0785141, -97.8380127]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-27",
                              "group": "RD-5",
                              "territoryscore": 11.5079990216557
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [29.52903748, -95.52352905]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-8",
                              "group": "RD-5",
                              "territoryscore": 15.5597566664032
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [29.89461136, -92.19317627]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-54",
                              "group": "RD-5",
                              "territoryscore": 1.62021783723016
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [30.20655632, -90.99700165]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-42",
                              "group": "RD-6",
                              "territoryscore": 3.07217882222521
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [41.36741257, -95.99661255]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-14",
                              "group": "RD-6",
                              "territoryscore": 32.0680908657518
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [37.62818527, -97.49967957]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-20",
                              "group": "RD-6",
                              "territoryscore": 6.74052122868435
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.11434555, -94.52323151]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-50",
                              "group": "RD-6",
                              "territoryscore": 75.5647817173985
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [44.0952034, -85.11815643]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-15",
                              "group": "RD-6",
                              "territoryscore": 52.9748976561883
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [45.10640335, -93.49703217]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-21",
                              "group": "RD-3",
                              "territoryscore": 28.0302453051553
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.1314621, -88.02632904]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-6",
                              "group": "RD-3",
                              "territoryscore": 51.1248956905388
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [35.76341248, -78.78852844]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-41",
                              "group": "RD-3",
                              "territoryscore": 33.0027891153993
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [40.01981354, -83.01509857]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-5",
                              "group": "RD-3",
                              "territoryscore": 21.0085082552452
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.51844406, -87.9826355]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-60",
                              "group": "RD-3",
                              "territoryscore": 86.2707689916647
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.61193466, -83.33808899]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-10",
                              "group": "RD-3",
                              "territoryscore": 51.7511351016359
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.29540634, -87.9506073]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-49",
                              "group": "RD-3",
                              "territoryscore": 5.57261048317961
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [42.97345352, -78.84619904]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-18",
                              "group": "RD-2",
                              "territoryscore": 25.7691829905316
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [45.41352463, -122.5367584]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-38",
                              "group": "RD-2",
                              "territoryscore": 9.4842985255191
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [35.99584579, -115.1576157]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-48",
                              "group": "RD-2",
                              "territoryscore": 64.4136616470155
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [47.61382675, -122.1443634]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-3",
                              "group": "RD-2",
                              "territoryscore": 8.17100720014197
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.530895, -119.814972]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-11",
                              "group": "RD-2",
                              "territoryscore": 52.1874906091888
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [43.64958572, -116.4317551]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-4",
                              "group": "RD-2",
                              "territoryscore": 12.492850988439
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.95080566, -105.1594925]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-44",
                              "group": "RD-2",
                              "territoryscore": 46.0034410673635
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.77267456, -105.1047974]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-53",
                              "group": "RD-8",
                              "territoryscore": 0.69124152257303
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [37.79538727, -122.4224472]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-22",
                              "group": "RD-8",
                              "territoryscore": 20.6034353032592
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [34.83179092, -120.4335098]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-26",
                              "group": "RD-8",
                              "territoryscore": 78.2905122762309
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [33.30324173, -111.741806]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-30",
                              "group": "RD-8",
                              "territoryscore": 18.9492882710973
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [33.88915253, -118.4021301]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-25",
                              "group": "RD-8",
                              "territoryscore": 1.62304674433586
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [33.62723923, -112.0484161]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-34",
                              "group": "RD-8",
                              "territoryscore": 63.3867225908168
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [32.98360443, -117.0190353]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-29",
                              "group": "RD-8",
                              "territoryscore": 4.78037124866209
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [37.80876541, -122.2691574]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-19",
                              "group": "RD-7",
                              "territoryscore": 33.3667736609154
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [38.6104126, -90.29172516]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-17",
                              "group": "RD-7",
                              "territoryscore": 5.53952074931064
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.41363144, -84.65267944]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-31",
                              "group": "RD-7",
                              "territoryscore": 74.7975636830509
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [35.11051941, -89.94350433]
                            }
                        },
                          {
                            "type": "Feature",  
                            "properties": { 
                              "name": "Rep-59",
                              "group": "RD-7",
                              "territoryscore": 77.6344164241844
                            },
                            "geometry": {
                              "type": "Point",
                              "coordinates": [39.96260452, -86.17475891]
                            }
                        },
                  ]
  };

	/* We simply pick up the SVG from the map object */
	var svg = d3.select("#map").select("svg")
    .attr("pointer-events", "auto");
	g = svg.append("g");
    /* Add a LatLng object to each item in the dataset */
  var p=[]
  reps.features.forEach(function(d) {
      d.LatLng = new L.LatLng(d.geometry.coordinates[0],
                              d.geometry.coordinates[1]);
      p.push([d.geometry.coordinates[0],d.geometry.coordinates[1]]);
  })
  var states = [];

    function checkAndAdd(name) {
        var id = states.length + 1;
        var found = states.some(function (e) {
            return e.properties.id === name;
        });
        
        if (!found) {
          states.push({
              "type": "Feature",
              "properties": {"id":name},
              "geometry": {
                "type": "Polygon",
                "coordinates": [],
                "points":[]
            }
          });
        }
    }
    // Clone the object, not just passing reference
    var initialStates = JSON.parse(JSON.stringify(states));
    var initialReps = JSON.parse(JSON.stringify(reps));
    var story = [
        {"id":"1", "point":"Rep-56",  "from":"RD-1", "to":"RD-7",	"ts": 3526.89047616342},
        {"id":"2", "point":"Rep-37",  "from":"RD-1", "to":"RD-9",	"ts":	2617.79937692735},
        {"id":"3", "point":"Rep-5",   "from":"RD-3", "to":"RD-6",	  "ts":	2169.6250047867},
        {"id":"4", "point":"Rep-38",  "from":"RD-2", "to":"RD-8",	"ts":	2120.51289671583},
        {"id":"5", "point":"Rep-14",  "from":"RD-6", "to":"RD-9",	"ts":	2079.82293247039},
        {"id":"6", "point":"Rep-10",  "from":"RD-3", "to":"RD-6",	"ts":	1502.27480620499},    
    ];


    function getHull(){
        // Clean all points in states
        states.forEach(function(e){e.geometry.points=[];});
        // Assign poitns
        reps.features.forEach(function(d) {
          // check if the rd exists in the states
            checkAndAdd(d.properties.group);
            var target = states.find(function(g){
                return g.properties.id===d.properties.group
            });
            target.geometry.points.push([d.geometry.coordinates[0],d.geometry.coordinates[1]]);
        })
        //Calculate hull
        states.forEach(function(e){
            if(e.geometry.points.length>=3){            
              var hull =  d3.polygonHull(e.geometry.points);
              hull.push([]);
              e.geometry.coordinates = [hull];
            }
      });
    }
    

    function projectPoint(x, y) {
        var point = map.latLngToLayerPoint(new L.LatLng(x, y));
        this.stream.point(point.x, point.y);
    }

    var transform = d3.geoTransform({point: projectPoint});
    var path = d3.geoPath().projection(transform);

    var index = 0;
    var blinkRepName = story[index].point;
    var blink = reps.features.findIndex(x => x.properties.name==blinkRepName);

    // Draw the convex hull
    getHull();

    var featureHull =  svg.selectAll("path")
        .data(states)
        .enter()
        .append("path")
        .attr("class", function(d){
          return "group "+d.properties.id.replace(/\s/g,'')})

    var blinkHull =  svg.selectAll("path")
        .data(states)
        .enter()
        .append("path")
        .attr("class", function(d){
          return "group "+d.properties.id.replace(/\s/g,'')})

    // Define the div for the tooltip
    var div = d3.select("body").append("div")	
        .attr("class", "tooltip")				
        .style("opacity", 0);        
    // reps dot
    var feature = g.selectAll("circle")
        .data(reps.features)
        .enter()
        .append("circle")
        .attr("class", "dot")
        .style("opacity", .9) 
        .style("fill", "red")
        .style("stroke","black")
        .attr("r", 6)
        .on("mouseover", function(d) {
            div.transition()
                .duration(200)		
                .style("opacity", .9);		
            div.html("Name: "+d.properties.name + "<br/>"  + "Region: "+d.properties.group+ "<br/>"+"TS: " +d.properties.territoryscore.toFixed(2))	
                .style("left", (d3.event.pageX) + "px")		 //
                .style("top",  (d3.event.pageY - 28)+ "px");	 //
            })					
        .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);
        });

    var featureLabel = svg.selectAll(".place-label")
            .data(reps.features)
            
    var blinkRing = svg.selectAll("ring")
        .data(reps.features);

    var textLabel = svg.append("text")
        .attr('x', 200)
        .attr('y', 100)
        .style("font-size", "26px")
        .attr('fill', '#000')
        .text(function(d) { return "Initial State" });
    var width = 1024
    var upperTs = story[0].ts

    function tsToPx(ts){return width*ts/upperTs}

    var progress_label = svg.append('text')
        .attr('x', width-180)
        .attr('y', 50)
        .style("font-size", "26px")
        .attr('fill', '#000')
        .text(function(d) { return "Var. TS: "+upperTs.toFixed(0) });

    var progress = svg.append('rect')
        .attr('class', 'progress-rect')
        .attr('fill', "grey")
        .attr('height', 15)
        .attr('width', width)
        .attr('rx', 10)
        .attr('ry', 10)
        .attr('x', 0);
    var time_stage = 7000        
// Start the main process
    var blinkingID;
    var storyTransitionID;
    var blink = reps.features.findIndex(x => x.properties.name==blinkRepName);
    d3.select("#play")
      .on("click",function(){
          var self = d3.select(this);
          if (playButton.state.nextState=="paused"){
            blinkingID = setInterval(transition, 300);
            storyTransitionID = setInterval(script, time_stage);
          }else{
            clearInterval(storyTransitionID);
            clearInterval(blinkingID);
          }
    });//end click function
    map.on("moveend", update);
    map.on('zoomend', update);
    update();

    function update() {
        featureHull.attr("d", path)

        feature.attr("transform", function(d) { 
            return "translate("+ 
                map.latLngToLayerPoint(d.LatLng).x +","+ 
                map.latLngToLayerPoint(d.LatLng).y +")";
        });

        featureLabel
          .filter(function(d,i){return i===blink;})
          .attr("transform", function(d) { 
              return "translate(" + 
                  (map.latLngToLayerPoint(d.LatLng).x+10) +","+ 
                  (map.latLngToLayerPoint(d.LatLng).y-10) +")";
          })
          .text(function(d) { return "Next: "+d.properties.name; }); 

    }
    
    function script(){

        //update();
        // Blinking point id
        blinkRepName = story[index].point;
        blink = reps.features.findIndex(x => x.properties.name==blinkRepName);
        blinkState = states.findIndex(x => x.properties.id==story[index].to);

        // Change the group
        reps.features[blink].properties.group = story[index].to;

        // Update the hull object
        getHull();
        
        textLabel
          .transition().duration(500) // Speed of fade-out
            .style("opacity", 0)
            .transition().duration(500) // Speed of fade-in
            .style("opacity", 1)
          .text(function(d) { return story[index].point+" is moved from "+story[index].from+" to "+story[index].to });
        
        featureLabel.enter()
            .append("text")
            .attr("class", "place-label")
            .filter(function(d,i){return i===blink;})
            .attr("transform", function(d) { 
            return "translate(" + 
                (map.latLngToLayerPoint(d.LatLng).x) +","+ 
                (map.latLngToLayerPoint(d.LatLng).y-20) +")";
            })
            .attr("dy", ".35em")
            .text(function(d) {return d.properties.name; })
            .transition()
            .duration(time_stage)
            .remove();

        var time_blink = 800
        featureHull.data(states)
          .filter(function(d,i){return i===blinkState})
          .transition().duration(time_blink) // Speed of fade-out
            .style("opacity", 0.9)
          .transition().duration(time_blink) // Speed of fade-in
            .style("opacity", 0.1)
          .transition().duration(time_blink) // Speed of fade-in
            .style("opacity", 0.9)
          .transition().duration(time_blink) // Speed of fade-in
            .style("opacity", 0.1)
          .transition().duration(time_blink) // Speed of fade-in
            .style("opacity", 0.9)
          .transition().duration(time_blink) // Speed of fade-in
            .style("opacity", 0.5)

        // draw hull
        featureHull.data(states)
          .transition()
            .ease(d3.easeLinear)
            .delay(5000)
            .duration(2000)
            .attr("d", path)

        progress_label.transition()
          .duration(1000)
          .attr('x',tsToPx(story[index].ts)-180)
          .text(function(d) { return "Var. TS "+story[index].ts.toFixed(0) });

        progress.transition()
          .duration(1000)
          .attr('width', tsToPx(story[index].ts))

        // update the story
        index++;
        if(index==(story.length)){
          console.log("Clear the interval");
          //setTimeout(clearInterval(storyTransitionID),5000);
          
          clearInterval(storyTransitionID);
         
          //clearInterval(blinkingID);
        }
    }
    
    function transition(){
        blinkRing.enter()
        .append("circle")
        // Using filter to select a specific element
        .filter(function(d,i){return i===blink;})
            .attr("class", "ring")
            .attr("transform", function(d) { 
                return "translate("+ 
                    map.latLngToLayerPoint(d.LatLng).x +","+ 
                    map.latLngToLayerPoint(d.LatLng).y +")";})
            .attr("r", 6)
            .style("stroke-width", 1)
            .style("stroke", "red")
            .style("fill", "none")
        .transition()
            .ease(d3.easeLinear)
            .duration(1000) // Change Speed
            .style("stroke-opacity", 1e-6)
            .style("stroke-width", 3)
            .style("stroke", "red")
            .attr("r", 35)
            .remove();
    }

    function previous(){
      if(index>=2){
        index = index-2;
      }
      else{
        index = story.length-2
      }
      script();
      update();
    }


    function reset(){
          // Shut down Process
          clearInterval(storyTransitionID);
          clearInterval(blinkingID);
          // clear all scheduled transition
          d3.selectAll("path").transition();
          d3.selectAll("ring").transition();
          //initial 
          index = 0;
          blinkRepName = story[index].point;
          blink = reps.features.findIndex(x => x.properties.name==blinkRepName);
          blinkState = states.findIndex(x => x.properties.id==story[index].to);

          reps =JSON.parse(JSON.stringify(initialReps));
          getHull();
          //update();
          featureHull.data(states)
          .transition()
            .ease(d3.easeLinear)
            .duration(2000)
            .attr("d", path)
          textLabel.text(function(d) { return "Initial State" });

          progress_label.transition()
            .duration(1000)
            .attr('x', width-180)
            .text(function(d) { return "Var. TS: "+upperTs.toFixed(0) });

          progress.transition()
            .duration(1000)
            .attr('width', width)
            .attr('x', 0);
          playButton.setState("playing");

          if (playButton.state.nextState=="paused"){
            $("#play").click();
          }
    }

    function goToStage(stage){
      clearInterval(storyTransitionID);
      clearInterval(blinkingID);
      // clear all scheduled transition
      d3.selectAll("path").transition();
      d3.selectAll("ring").transition();

      reps =JSON.parse(JSON.stringify(initialReps));
      index = stage;
      blinkRepName = story[index].point;
      blinkState = states.findIndex(x => x.properties.id==story[index].to);
      for(var i=0;i<=index;i++){
        blinkRepName = story[i].point;
        blink = reps.features.findIndex(x => x.properties.name==blinkRepName);
        reps.features[blink].properties.group = story[i].to;
      }
      getHull();
      //update();
      featureHull.data(states)
      .transition()
        .ease(d3.easeLinear)
        .duration(2000)
        .attr("d", path)
      textLabel.text(function(d) { return story[index].point+" is moved from "+story[index].from+" to "+story[index].to });

      progress_label.transition()
        .duration(1000)
        .attr('x',tsToPx(story[index].ts)-180)
        .text(function(d) { return "Var. TS: "+story[index].ts.toFixed(0) });

      progress.transition()
        .duration(1000)
        .attr('width', tsToPx(story[index].ts))
        .attr('x', 0);
      
    }



</script>
</body>
</html>